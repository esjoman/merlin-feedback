!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):b(a.merlinFeedback=a.merlinFeedback||{})}(this,function(a){"use strict";function b(a,b,c){return c.reduce(function(a,c,d){var e=0===d?"?":"&";return b[c]?""+a+e+c+"="+b[c]:a},a)}function c(a,b,c){if(!a||!b||!c)throw new Error(s);return"https://search-"+b+".search.blackbird.am/v1/"+a+"."+b+"."+c+"/products/feedback"}function d(){return"_xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}function e(a,b,c){var d=a[b];return d?[].concat(n(d),n(c)):c}function f(a,b){if(a instanceof RegExp)return a.test(b);if("function"==typeof a)return a(b);throw new Error(t)}function g(a,b,c,d){var e=arguments.length<=4||void 0===arguments[4]?{}:arguments[4],f=e.href,g=void 0===f?window.location.href:f,h=e.referrer,i=void 0===h?window.location.referrer:h,j=e.storage,k=void 0===j?window.localStorage:j;return new x(a,b,c,d,{href:g,referrer:i,storage:k})}var h=function(a,b){var c={};for(var d in a)b.indexOf(d)>=0||Object.prototype.hasOwnProperty.call(a,d)&&(c[d]=a[d]);return c},i=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),j=function(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a},k=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a},l=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},m=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),n=function(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)},o=Function.bind.call(Function.call,Array.prototype.reduce),p=Function.bind.call(Function.call,Object.prototype.propertyIsEnumerable),q=Function.bind.call(Function.call,Array.prototype.concat),r=Reflect.ownKeys;Object.entries||(Object.entries=function(a){return o(r(a),function(b,c){return q(b,"string"==typeof c&&p(a,c)?[[c,a[c]]]:[])},[])});var s="merlinFeedback takes 4 required arguments: company, environment, instance, serpRegex.\n  company: the name of the company,\n  environment: 'dev', 'staging', or 'prod',\n  instance: the name of the instance,\n  serpRegex: a function or regex that returns truthy for SERP urls.",t="merlinFeedback's 4th argument must be a RegExp or a function that returns truthy for SERP urls.",u=["qid","q","numfound","docids","uid","sid","num","start"],v="bbcart",w=function(){function a(){var b=arguments.length<=0||void 0===arguments[0]?window.localStorage:arguments[0],c=arguments.length<=1||void 0===arguments[1]?v:arguments[1];l(this,a),this.storage=b,this.key=c}return m(a,[{key:"add",value:function(a,b){var c=this.get();this.set(k({},c,j({},a,e(c,a,b))))}},{key:"remove",value:function(){}},{key:"get",value:function(){var a=this.storage.getItem(this.key)||"",b=a.split("###");return b.reduce(function(a,b){if(!b)return a;var c=b.split(":"),d=i(c,2),f=d[0],g=d[1],h=g.split(",");return k({},a,j({},f,e(a,f,h)))},{})}},{key:"set",value:function(a){var b=Object.entries(a).map(function(a){var b=i(a,2),c=b[0],d=b[1];return c+":"+d.join(",")}).join("###");this.storage.setItem(this.key,b)}}]),a}(),x=function(){function a(b,d,e,g,h){var i=h.href,j=h.referrer,k=h.storage;l(this,a),this.url=c(b,d,e),this.isSerp=f(g,i),this.href=i,this.referrer=j,this.storage=k,this.cart=new w(this.storage)}return m(a,[{key:"serp",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(this.isSerp){var b=a.qid||d();return this.storage.setItem(this.href,b),this._registerEvent("serp",k({},a,{qid:b}))}}},{key:"click",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=a.qid||this.storage.getItem(this.href);return b?this._registerEvent("click",k({},a,{qid:b})):void 0}},{key:"cartAdd",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=a.docids,c=void 0===b?[]:b,d=h(a,["docids"]),e=d.qid||this.storage.getItem(this.referrer);return e?(this.cart.add(e,c),this._registerEvent("cart_add",k({},d,{qid:e,docids:c}))):void 0}},{key:"cartRemove",value:function(){}},{key:"purchase",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return b.docids?this._registerEvent("purchase",b):Promise.all(Object.entries(this.cart.get()).map(function(c){var d=i(c,2),e=d[0],f=d[1];return a._registerEvent("purchase",k({},b,{qid:e,docids:f}))}))}},{key:"_registerEvent",value:function(a,c){var d=b(this.url+"/"+a,c,u);return fetch(d)}}]),a}();a.Cart=w,a.MerlinFeedback=x,a.init=g});