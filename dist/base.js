!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):b(a.merlinFeedback=a.merlinFeedback||{})}(this,function(a){"use strict";function b(a,b,c){var d=a[b]||[];return i({},a,m({},b,[].concat(n(d),n(c))))}function c(a){var b=typeof a;return!!a&&("object"==b||"function"==b)}function d(a,b,c){return c.reduce(function(a,c,d){var e=0===d?"?":"&";return b[c]?""+a+e+c+"="+b[c]:a},a)}function e(){return"_xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}function f(a,b){return a instanceof RegExp?a.test(b):a(b)}function g(a,b,c,d){var e=arguments.length<=4||void 0===arguments[4]?{}:arguments[4],f=e.useUrlChangeTracker,g=void 0!==f&&f,h=e.fallback,i=void 0===h?null:h;if(!a||!b||!c)throw new Error(w);if(!(d instanceof RegExp||"function"==typeof d))throw new Error(x);if(i){var j=i.mode;if("proxy"!==j)throw new Error(y);if("proxy"===j&&!i.url)throw new Error(z)}var k="https://search-"+b+".search.blackbird.am/v1/"+a+"."+b+"."+c+"/products/feedback";return new v(k,d,window.localStorage,A,g,i)}var h=function(a,b){var c={};for(var d in a)b.indexOf(d)>=0||Object.prototype.hasOwnProperty.call(a,d)&&(c[d]=a[d]);return c},i=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a},j=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},k=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),l=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),m=function(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a},n=function(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)},o=function(){function a(b,c){j(this,a),this.storage=b,this.key=c}return k(a,[{key:"add",value:function(a,c){var d=this.get(),e=b(d,a,c);this.set(e)}},{key:"remove",value:function(){}},{key:"get",value:function(){var a=this.storage.getItem(this.key);if(!a)return{};var b=a.split("###");return b.reduce(function(a,b){var c=b.split(":"),d=l(c,2),e=d[0],f=d[1];return i({},a,m({},e,f.split(",")))},{})}},{key:"set",value:function(a){var b=Object.keys(a),c=b.map(function(b){return b+":"+a[b].join(",")}),d=c.join("###");this.storage.setItem(this.key,d)}}]),a}(),p=window,q=p.history,r=p.addEventListener,s=p.removeEventListener,t=function(){function a(b){j(this,a),q.pushState&&r&&(this.update=this.update.bind(this),this.handleUrlChanged=b,this.originalPushState=q.pushState,q.pushState=function(a,b){c(a)&&b&&(a.title=b),this.originalPushState.apply(q,arguments),this.update()}.bind(this),this.originalReplaceState=q.replaceState,q.replaceState=function(a,b){c(a)&&b&&(a.title=b),this.originalReplaceState.apply(q,arguments),this.update()}.bind(this),r("popstate",this.update))}return k(a,[{key:"update",value:function(){var a=this;setTimeout(function(){a.handleUrlChanged()},0)}},{key:"remove",value:function(){s("popstate",this.update),q.replaceState=this.originalReplaceState,q.pushState=this.originalPushState}}]),a}(),u=["qid","q","numfound","docids","uid","sid","num","start"],v=function(){function a(b,c,d,e,f,g){j(this,a),this.url=b,this.serpRegex=c,this.storage=d,this.cart=new o(d,e),this.previousHref=window.location.referrer,this.currentHref=window.location.href,f&&(this.handleUrlChanged=this.handleUrlChanged.bind(this),this.urlChangeTracker=new t(this.handleUrlChanged)),g&&(this.fallback=g,this.useFallback=!1)}return k(a,[{key:"serp",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(!f(this.serpRegex,this.currentHref))return null;var b=a.qid||e();return this.storage.setItem(this.currentHref,b.toString()),this._registerEvent("serp",i({},a,{qid:b}))}},{key:"click",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=a.qid||this.storage.getItem(this.currentHref);return b?this._registerEvent("click",i({},a,{qid:b})):null}},{key:"cartAdd",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=a.docids,c=void 0===b?[]:b,d=h(a,["docids"]),e=d.qid||this.storage.getItem(this.previousHref);return e?(this.cart.add(e,c),this._registerEvent("cart_add",i({},d,{qid:e,docids:c}))):null}},{key:"cartRemove",value:function(){}},{key:"purchase",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(b.docids)return this._registerEvent("purchase",b);var c=this.cart.get(),d=Object.keys(c),e=d.map(function(d){return a._registerEvent("purchase",i({},b,{qid:d,docids:c[d]}))});return Promise.all(e)}},{key:"handleUrlChanged",value:function(){var a=arguments.length<=0||void 0===arguments[0]?window.location.href:arguments[0];a!==this.currentHref&&(this.previousHref=this.currentHref,this.currentHref=a)}},{key:"_registerEvent",value:function(a,b){var c=d(this.url+"/"+a,b,u);return this._fetchWithFallback(c)}},{key:"_fetchWithFallback",value:function(a){var b=this;if(!this.fallback)return fetch(a);if(this.useFallback&&"proxy"===this.fallback.mode){var c=this.fallback.url,d="/"===c.slice(-1)?c.slice(0,-1):c;return fetch(d+"/"+a)}return fetch(a)["catch"](function(){return b.useFallback=!0,b._fetchWithFallback(a)})}}]),a}(),w="merlinFeedback takes 4 required arguments: company, environment, instance, serpRegex.\n  company: the name of the company,\n  environment: 'dev', 'staging', or 'prod',\n  instance: the name of the instance,\n  serpRegex: a function or regex that returns truthy for SERP urls.",x="merlinFeedback's 4th argument must be a RegExp or a function that returns truthy for SERP urls.",y="Currently, the only available `fallback.mode` is `'proxy'`.",z="Using `fallback.mode === 'proxy'` requires a `fallback.url` which will be prepended to the feedback request.",A="bbcart";a.init=g,a.Cart=o,a.MerlinFeedback=v,Object.defineProperty(a,"__esModule",{value:!0})});
//# sourceMappingURL=base.js.map